import React, { useState, useEffect } from 'react';
import { 
  LayoutDashboard, 
  TrendingUp, 
  Clock, 
  Heart, 
  Users, 
  RefreshCw, 
  Download,
  CheckCircle2,
  AlertCircle,
  Share2,
  Mail,
  Copy,
  MessageSquareQuote,
  Zap,
  Scale,
  Sparkles,
  FileDown,
  Briefcase,
  Database,
  Type,
  MapPin,
  Building2,
  Image as ImageIcon,
  X,
  ClipboardCheck,
  ThumbsUp,
  Calendar,
  Filter,
  UserCheck,
  UserX,
  Activity,
  ArrowRight,
  Key,
  User,
  ArrowUpRight,
  ArrowDownRight,
  History,
  Sliders,
  Calculator,
  Timer,
  Focus,
  Target,
  Award,
  Smartphone,
  Moon,
  BrainCircuit,
  Lightbulb,
  HelpCircle,
  Shield,
  ShieldCheck,
  Lock,
  Info,
  Banknote
} from 'lucide-react';

// --- SAPIA BRAND TOKENS ---
const BRAND = {
  pink: '#FFCEFF',      
  black: '#000000',     
  white: '#FFFFFF',     
};

const MODEL_NAME = "gemini-3-flash-preview";

const LinkedinIcon = ({ size = 20, ...props }) => (
  <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>
    <path d="M16 8a6 6 0 0 1 6 6v7h-4v-7a2 2 0 0 0-2-2 2 2 0 0 0-2 2v7h-4v-7a6 6 0 0 1 6-6z"></path>
    <rect x="2" y="9" width="4" height="12"></rect>
    <circle cx="4" cy="4" r="2"></circle>
  </svg>
);

const App = () => {
  const [view, setView] = useState('entry'); 
  const [analyzing, setAnalyzing] = useState(false);
  const [reportData, setReportData] = useState(null);
  const [error, setError] = useState(null);
  const [copied, setCopied] = useState(false);
  
  // --- FEATURES STATE ---
  const [localApiKey, setLocalApiKey] = useState('');
  const [customerLogo, setCustomerLogo] = useState(null);
  const [showTrends, setShowTrends] = useState(false);
  
  // --- PRIVACY STATE ---
  const [privacyMode, setPrivacyMode] = useState(true); 
  
  // --- AI INSIGHTS STATE ---
  const [aiInsights, setAiInsights] = useState({ roadmap: null, qa: null });
  const [generatingInsight, setGeneratingInsight] = useState(null);

  // --- FORM STATE ---
  const [formData, setFormData] = useState({
    customerName: '',
    industry: 'Retail',
    range: 'Metro', 
    dateRange: 'Monthly',
    persona: 'Overall Strategy', 
    targetFocus: 'Highest Impact', 
    totalInvites: '', 
    completions: '',
    leakageRate: '', 
    dropOutRate: '', 
    timeToHireSapia: '',
    timeToOfferSapia: '', 
    hoursSaved: '', 
    csat: '',
    nps: '', 
    insightsUseful: '', 
    deiStat: '',
    verbatimFeedback: '',
    prevTimeToHire: '',
    prevCsat: '',
    prevNps: '',
    actualHires: '',
    percentMobile: '', 
    percentAfterHours: '',
    // NEW RETENTION METRICS
    costPerLeaver: '5000', // Default conservative estimate
    sapiaRetention: '' // % of YES hires retained > 90 days
  });

  const [files, setFiles] = useState([]);

  // --- 4. SESSION PERSISTENCE (AUTO-SAVE) ---
  useEffect(() => {
    const savedData = localStorage.getItem('sapia_story_data');
    const savedKey = localStorage.getItem('sapia_api_key');
    if (savedData) {
      try {
        setFormData(JSON.parse(savedData));
      } catch (e) { console.error("Could not load saved data"); }
    }
    if (savedKey) setLocalApiKey(savedKey);
  }, []);

  useEffect(() => {
    localStorage.setItem('sapia_story_data', JSON.stringify(formData));
  }, [formData]);

  useEffect(() => {
    localStorage.setItem('sapia_api_key', localApiKey);
  }, [localApiKey]);

  // --- AUTO-CALCULATE HOURS SAVED ---
  const handleInputChange = (e) => {
    const { name, value } = e.target;
    
    setFormData(prev => {
      const newData = { ...prev, [name]: value };
      
      if (name === 'completions') {
        const count = parseFloat(value.replace(/,/g, '')) || 0;
        const calculatedHours = Math.round(count * 0.42);
        newData.hoursSaved = calculatedHours > 0 ? calculatedHours.toString() : '';
      }
      
      return newData;
    });
  };

  const handleFileChange = (e) => {
    const selectedFiles = Array.from(e.target.files);
    selectedFiles.forEach(file => {
      const reader = new FileReader();
      reader.onloadend = () => {
        setFiles(prev => [...prev, {
          id: Math.random().toString(36).substr(2, 9),
          base64: reader.result.split(',')[1],
          preview: reader.result,
          name: file.name
        }]);
      };
      reader.readAsDataURL(file);
    });
  };

  const handleLogoChange = (e) => {
    const file = e.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onloadend = () => {
        setCustomerLogo(reader.result);
      };
      reader.readAsDataURL(file);
    }
  };

  const removeFile = (id) => {
    setFiles(prev => prev.filter(f => f.id !== id));
  };

  const copyToClipboard = (text) => {
    if (!text) return;
    navigator.clipboard.writeText(text);
    setCopied(true);
    setTimeout(() => setCopied(false), 2000);
  };

  const handleExport = () => {
    setView('dashboard');
    setTimeout(() => window.print(), 100);
  };

  // --- AI INSIGHT GENERATORS ---
  const generateAiInsight = async (type) => {
    if (!localApiKey) {
      setError("Please add your Google AI API Key in the Data Entry tab.");
      return;
    }
    setGeneratingInsight(type);
    
    const safeCustomerName = privacyMode ? "The Customer" : formData.customerName;

    let prompt = "";
    if (type === 'roadmap') {
        prompt = `
            You are a strategic HR consultant. Based on the following Sapia.ai performance data for ${safeCustomerName}:
            ${JSON.stringify(reportData.metrics)}
            Funnel Efficiency: ${JSON.stringify(reportData.funnel)}
            
            Generate a 3-step "Strategic Roadmap" for the next quarter.
            CRITICAL: STRICTLY USE ONLY THE METRICS PROVIDED ABOVE. DO NOT INVENT NEW DATA POINTS OR BASELINES.
            Focus on actionable steps related to recruitment efficiency, candidate experience, or funnel optimization.
            Return a JSON array: [{"step": "Step 1 Title", "desc": "Brief actionable description"}, ...]
        `;
    } else if (type === 'qa') {
        prompt = `
            You are coaching a TA Leader on how to present to a ${formData.persona}.
            Based on this performance data:
            ${JSON.stringify(reportData.metrics)}
            ROI: ${JSON.stringify(reportData.roi)}
            
            Predict 3 difficult or skeptical questions this ${formData.persona} might ask.
            Provide a concise, data-backed answer for each using the metrics provided.
            Return a JSON array: [{"question": "The question?", "answer": "The data-backed answer."}]
        `;
    }

    try {
        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent?key=${localApiKey}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                contents: [{ parts: [{ text: prompt }] }],
                generationConfig: { responseMimeType: "application/json" }
            })
        });
        
        const result = await response.json();
        const parsed = JSON.parse(result.candidates[0].content.parts[0].text);
        
        setAiInsights(prev => ({ ...prev, [type]: parsed }));
    } catch (e) {
        console.error(e);
        setError("Could not generate insights. Please try again.");
    } finally {
        setGeneratingInsight(null);
    }
  };

  const generateStory = async () => {
    if (!localApiKey) {
      setError("Please add your Google AI API Key in the Connection field above.");
      return;
    }

    setAnalyzing(true);
    setError(null);

    const actualHiresInput = parseFloat(formData.actualHires.replace(/,/g, '')) || 0;
    let extrapolatedAnnualHires = actualHiresInput;
    if (formData.dateRange === 'Monthly') extrapolatedAnnualHires = actualHiresInput * 12;
    if (formData.dateRange === 'Quarterly') extrapolatedAnnualHires = actualHiresInput * 4;

    const safeCustomerName = privacyMode ? "The Client" : formData.customerName;
    const safeFeedback = privacyMode ? "[Confidential Candidate Feedback Provided Analysis]" : formData.verbatimFeedback;

    const systemPrompt = `
      You are the Lead Talent Strategist at Sapia.ai.
      Turn raw recruitment metrics into a board-ready impact story.
      
      SOURCE OF TRUTH PROTOCOL:
      1. MANUAL DATA ENTRY (provided below) is the PRIMARY SOURCE OF TRUTH. 
      2. UPLOADED SCREENSHOTS (if any) are the SECONDARY SOURCE.
      3. Scan screenshots for "High Impact Numbers" (e.g., >95% completion, specific diversity wins, glowing candidate quotes) that might not be in the manual entry.
      4. If you find a meaningful stat in a screenshot that adds value (and doesn't conflict with manual data), include it in the 'Board Win' or 'Talking Points'.
      
      TARGET AUDIENCE: ${formData.persona}
      REPORT FOCUS: ${formData.targetFocus}

      CPO HAT (ACCESSIBILITY & BRAND FOCUS):
      - Highlight "Feedback Coverage": Sapia gives 100% of completions feedback. Industry avg is <15%. This solves ghosting.
      - Highlight "Accessibility": High mobile usage and after-hours completion proves we are reaching diverse/passive talent.

      BENCHMARKING & DATA SOURCES:
      - Use accepted industry standards (e.g., Josh Bersin, SHRM, LinkedIn Talent, Global CandE Benchmark).
      - For Candidate Experience (NPS/CSAT), explicitly reference the 'Global Candidate Experience Benchmark'.
      - For TTH/TTO, reference 'Industry Standard'.
      - For Retention, assume a standard Industry 90-Day Retention rate for ${formData.industry} (e.g., Retail is ~70%).
      - RETURN a specific 'benchmarkSource' string in the JSON.
      
      ROI CALCULATION LOGIC:
      - RECRUITER EFFICIENCY (Cash Release): $18 saved per candidate (based on $43/hr recruiter rate * 0.42 hours).
      - RETENTION ECONOMICS (Cost Avoidance): 
        * Identify Industry 90-Day Retention for ${formData.industry}.
        * Delta = Sapia Retention Rate (${formData.sapiaRetention}%) - Industry Rate.
        * Annual Hires = ${extrapolatedAnnualHires}.
        * Retention Savings = Annual Hires * (Delta %) * Cost Per Leaver ($${formData.costPerLeaver}).
      - Scale annual savings based on Date Range (Monthly x12, Quarterly x4).
      
      COMMS STRATEGY:
      - LinkedIn: Write as Sapia.ai celebrating the customer. Avoid "partnership with". Start with impact: "Exciting News! Sapia.ai has driven significant improvements..."
      - Internal Email: Structure strictly as an email (Subject/Body).
      
      CRITICAL: 
      - NO ITALICS in your generated descriptions, headlines, or labels.
      - Italics are strictly forbidden except in the "topQuote" field.
      
      JSON STRUCTURE:
      {
        "meta": { "benchmarkSource": "string" },
        "metrics": {
          "tth": { "sapia": number, "industry": number }, 
          "tto": { "sapia": number, "industry": number },
          "annualHoursSaved": number,
          "hmHoursSaved": number,
          "csat": { "sapia": number, "industry": number },
          "nps": { "sapia": number, "industry": number },
          "insightsUseful": { "sapia": number, "industry": 65 },
          "completions": number,
          "totalInvites": number,
          "fastHiresPercent": number,
          "percentMobile": number,
          "percentAfterHours": number,
          "hoursPerLocation": number
        },
        "funnel": {
          "leakagePercent": number,
          "dropOutPercent": number,
          "controlInsight": "string",
          "contextInsight": "string"
        },
        "roi": { 
          "annualDollarsSaved": number,
          "retentionDollarsSaved": number,
          "recruiterCapacityIncrease": "percentage string",
          "relativeImpactText": "string",
          "retentionDelta": number
        },
        "candidateLove": {
          "nps": number,
          "topQuote": "string",
          "themes": ["string", "string", "string"],
          "fairnessOddsText": "string"
        },
        "dei": { "status": "string", "improvement": "string" },
        "strategy": {
          "headline": "string",
          "boardWin": "string",
          "talkingPoints": ["string", "string", "string"]
        },
        "comms": {
          "linkedin": "string",
          "internalEmail": "string"
        }
      }
    `;

    const userPrompt = `
      STRATEGIC CONTEXT:
      - Customer: ${safeCustomerName}
      - Industry: ${formData.industry}
      - Recruitment Range: ${formData.range}
      - Date Range: ${formData.dateRange}
      - Target Persona: ${formData.persona}
      - Report Focus: ${formData.targetFocus}
      - Number of Hiring Locations/Managers: ${formData.numLocations}

      RAW METRICS (MANUAL SOURCE OF TRUTH):
      - Total Candidates Invited: ${formData.totalInvites}
      - Chat Completions: ${formData.completions}
      - Leakage Rate (Did not start): ${formData.leakageRate}%
      - Drop Out Rate (Started but didn't finish): ${formData.dropOutRate}%
      - Time to Hire (Sapia): ${formData.timeToHireSapia} days
      - Time to Offer (Sapia): ${formData.timeToOfferSapia} days
      - % Hires Under 7 Days: ${formData.fastHiresPercent}%
      - Hours Saved (${formData.dateRange}): ${formData.hoursSaved} hours
      - CSAT: ${formData.csat}/10
      - Brand Advocacy (NPS): ${formData.nps}%
      - My Insights Value: ${formData.insightsUseful}%
      - Feedback: ${safeFeedback}
      - Raw DEI Data (for Odds calculation): ${formData.deiRawData}
      - Actual Hires in Period: ${formData.actualHires} (Annual Extrapolation: ${extrapolatedAnnualHires})
      - Mobile Completion: ${formData.percentMobile}%
      - After Hours Completion: ${formData.percentAfterHours}%
      
      RETENTION ECONOMICS:
      - Cost per Early Leaver: $${formData.costPerLeaver}
      - Sapia 90-Day Retention Rate (YES candidates): ${formData.sapiaRetention}%
    `;

    try {
      const parts = [{ text: userPrompt }];
      
      if (!privacyMode) {
          files.forEach(file => {
              const base64Data = file.base64; 
              parts.push({
                  inlineData: {
                      mimeType: "image/png", 
                      data: base64Data
                  }
              });
          });
      }

      const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent?key=${localApiKey}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          contents: [{ parts: parts }],
          systemInstruction: { parts: [{ text: systemPrompt }] },
          generationConfig: { responseMimeType: "application/json" }
        })
      });

      if (!response.ok) throw new Error('Story generation failed. Check your API key.');
      
      const result = await response.json();
      const parsed = JSON.parse(result.candidates[0].content.parts[0].text);
      setReportData(parsed);
      setView('dashboard');
    } catch (err) {
      console.error(err);
      setError("Failed to generate story. Please verify your API Key and try again.");
    } finally {
      setAnalyzing(false);
    }
  };

  return (
    <div className="min-h-screen bg-[#FFCEFF] text-black font-sans selection:bg-black selection:text-white pb-20">
      <style>
        {`@media print { body { background: #FFCEFF !important; -webkit-print-color-adjust: exact; } nav, .no-print { display: none !important; } main { padding-top: 0px !important; } .print-container { width: 100% !important; max-width: 100% !important; margin: 0 !important; } .bg-white { background: white !important; } .shadow-2xl, .shadow-xl { box-shadow: none !important; border: 1px solid rgba(0,0,0,0.1) !important; } }`}
      </style>

      {/* Navigation */}
      <nav className="fixed top-0 left-0 right-0 h-20 bg-transparent px-8 flex items-center justify-between z-50 no-print">
        <div className="flex items-center gap-4">
          <span className="text-xl font-bold tracking-tight uppercase">Storyteller Studio</span>
        </div>

        {reportData && (
          <div className="flex items-center gap-1 bg-white/40 backdrop-blur-md p-1 rounded-full border border-black/5 shadow-sm">
            <NavBtn active={view === 'entry'} onClick={() => setView('entry')} icon={<Database size={16} />} label="Data Entry" />
            <NavBtn active={view === 'dashboard'} onClick={() => setView('dashboard')} icon={<LayoutDashboard size={16} />} label="Impact Dashboard" />
            <NavBtn active={view === 'comms'} onClick={() => setView('comms')} icon={<Share2 size={16} />} label="Social Comms" />
            <div className="w-px h-4 bg-black/10 mx-1" />
            <button onClick={handleExport} className="flex items-center gap-2 px-6 py-2.5 rounded-full font-bold text-[11px] uppercase tracking-widest bg-black text-white hover:bg-black/90 transition-all">
              <FileDown size={16} /> Export PDF
            </button>
          </div>
        )}
      </nav>

      <main className="pt-32 px-6 max-w-6xl mx-auto print-container">
        {/* --- DATA ENTRY VIEW --- */}
        {view === 'entry' && (
          <div className="animate-in fade-in duration-700">
            <div className="text-center max-w-3xl mx-auto mb-16">
              <h1 className="text-5xl font-bold tracking-tighter mb-6 leading-[1.05]">
                Hire <span className="text-white">brilliant.</span>
              </h1>
              <p className="text-2xl text-black/70 font-medium leading-tight mb-8">Quantify the science of human potential and operational efficiency.</p>
              
              {/* API KEY CONNECTION FIELD WITH PRIVACY TOGGLE */}
              <div className="max-w-xl mx-auto flex flex-col items-center gap-4">
                <div className="w-full relative group">
                    <div className="absolute inset-y-0 left-4 flex items-center pointer-events-none">
                    <Key size={16} className={localApiKey ? "text-green-500" : "text-black/30"} />
                    </div>
                    <input 
                    type="password" 
                    placeholder="Paste Google AI API Key to Connect..." 
                    value={localApiKey}
                    onChange={(e) => setLocalApiKey(e.target.value)}
                    className="w-full bg-white/50 backdrop-blur-sm border border-black/10 rounded-full py-3 px-12 focus:outline-none focus:bg-white focus:border-black transition-all text-xs font-bold uppercase tracking-widest placeholder:text-black/30"
                    />
                    {localApiKey && (
                    <div className="absolute right-4 inset-y-0 flex items-center">
                        <CheckCircle2 size={16} className="text-green-500" />
                    </div>
                    )}
                </div>
                
                {/* PRIVACY TOGGLE */}
                <button 
                    onClick={() => setPrivacyMode(!privacyMode)}
                    className={`flex items-center gap-2 px-4 py-2 rounded-full text-[10px] font-bold uppercase tracking-widest transition-all ${privacyMode ? 'bg-green-100 text-green-700 border border-green-200' : 'bg-red-50 text-red-600 border border-red-100'}`}
                >
                    {privacyMode ? <ShieldCheck size={14} /> : <AlertCircle size={14} />}
                    {privacyMode ? "Privacy Mode Active (PII Scrubbing On)" : "Privacy Mode Off (Sending PII)"}
                </button>
                {privacyMode && <p className="text-[10px] text-black/40 max-w-sm text-center">Customer Name and Verbatim Feedback will be anonymized before being sent to Google.</p>}
              </div>
            </div>

            {/* FULL WIDTH STRATEGIC CONTEXT - UX FIX */}
            <div className="mb-8">
                <div className="bg-white p-10 rounded-[3rem] shadow-xl border border-black/5 space-y-8">
                  <h3 className="text-xl font-bold flex items-center gap-2 uppercase tracking-tight font-sans"><Building2 className="text-black/30" /> Strategic Context</h3>
                  <div className="grid grid-cols-1 lg:grid-cols-4 gap-6">
                    <div className="lg:col-span-2">
                        <InputField label="Customer Name" name="customerName" value={formData.customerName} onChange={handleInputChange} placeholder="e.g. ALH Group" />
                    </div>
                    {/* CUSTOMER CO-BRANDING */}
                    <div className="space-y-2 lg:col-span-2">
                        <label className="text-[11px] font-bold uppercase tracking-widest opacity-40 font-sans">Customer Logo</label>
                        <div className="relative">
                            <input type="file" accept="image/*" onChange={handleLogoChange} className="hidden" id="logo-upload" />
                            <label htmlFor="logo-upload" className="w-full bg-black/5 border border-black/10 rounded-2xl py-3 px-4 flex items-center justify-between cursor-pointer hover:bg-black/10 transition-all h-[52px]">
                                {customerLogo ? (
                                    <div className="flex items-center gap-2">
                                        <img src={customerLogo} alt="Logo" className="h-6 w-auto object-contain" />
                                        <span className="text-xs text-green-600 font-bold">Uploaded</span>
                                    </div>
                                ) : (
                                    <span className="text-black/30 text-sm font-medium">Upload...</span>
                                )}
                                <ArrowUpRight size={14} className="text-black/30" />
                            </label>
                        </div>
                    </div>
                    
                    <div className="space-y-2">
                      <label className="text-[11px] font-bold uppercase tracking-widest opacity-40 font-sans">Industry</label>
                      <select name="industry" value={formData.industry} onChange={handleInputChange} className="w-full bg-black/5 border border-black/10 rounded-2xl py-4 px-6 focus:outline-none focus:border-black appearance-none font-medium font-sans">
                        {['Retail', 'Technology', 'Healthcare', 'Finance', 'Government', 'Manufacturing', 'Hospitality', 'Education'].map(ind => (
                          <option key={ind} value={ind}>{ind}</option>
                        ))}
                      </select>
                    </div>
                    <div className="space-y-2">
                      <label className="text-[11px] font-bold uppercase tracking-widest opacity-40 font-sans">Recruitment Range</label>
                      <select name="range" value={formData.range} onChange={handleInputChange} className="w-full bg-black/5 border border-black/10 rounded-2xl py-4 px-6 focus:outline-none focus:border-black appearance-none font-medium font-sans">
                        <option value="Metro">Metro</option>
                        <option value="Regional">Regional</option>
                        <option value="Both">Both (Metro & Regional)</option>
                      </select>
                    </div>
                    <div className="space-y-2">
                      <label className="text-[11px] font-bold uppercase tracking-widest opacity-40 font-sans">Date Range</label>
                      <select name="dateRange" value={formData.dateRange} onChange={handleInputChange} className="w-full bg-black/5 border border-black/10 rounded-2xl py-4 px-6 focus:outline-none focus:border-black appearance-none font-medium font-sans">
                        <option value="Monthly">Monthly</option>
                        <option value="Quarterly">Quarterly</option>
                        <option value="Yearly">Yearly</option>
                      </select>
                    </div>
                    <div className="space-y-2">
                      <label className="text-[11px] font-bold uppercase tracking-widest opacity-40 font-sans">Target Persona</label>
                      <select name="persona" value={formData.persona} onChange={handleInputChange} className="w-full bg-black/5 border border-black/10 rounded-2xl py-4 px-6 focus:outline-none focus:border-black appearance-none font-medium font-sans">
                        <option value="Overall Strategy">Overall Strategy (General)</option>
                        <option value="TA Leader">TA Leader</option>
                        <option value="TA Team">TA Team</option>
                        <option value="CFO">CFO</option>
                        <option value="CEO">CEO</option>
                        <option value="Head of HR">Head of HR</option>
                        <option value="CPO">CPO</option>
                        <option value="Governance & Risk">Governance & Risk (CRO)</option>
                      </select>
                    </div>
                  </div>

                  {/* REPORT FOCUS SELECTION */}
                  <div className="space-y-2">
                      <label className="text-[11px] font-bold uppercase tracking-widest opacity-40 font-sans">Report Focus</label>
                      <div className="grid grid-cols-2 lg:grid-cols-5 gap-2">
                        {['Highest Impact', 'Executive Summary', 'Candidate Love', 'Recruitment Funnel', 'DEI Impact'].map(focus => (
                            <button 
                                key={focus}
                                onClick={() => setFormData(prev => ({...prev, targetFocus: focus}))}
                                className={`py-3 px-4 rounded-xl text-[10px] font-bold uppercase tracking-wide transition-all text-center flex items-center justify-center gap-2 ${formData.targetFocus === focus ? 'bg-black text-white' : 'bg-black/5 text-black/40 hover:bg-black/10'}`}
                            >
                                {focus}
                                {formData.targetFocus === focus && <CheckCircle2 size={12} className="text-[#FFCEFF]" />}
                            </button>
                        ))}
                      </div>
                  </div>
                </div>
            </div>

            {/* SPLIT COLUMNS: Core (Left) vs Evidence/Qualitative (Right) */}
            <div className="grid grid-cols-1 lg:grid-cols-2 gap-8 items-start">
              
              {/* LEFT COLUMN: CORE PERFORMANCE */}
              <div className="space-y-8">
                <div className="bg-white p-10 rounded-[3rem] shadow-xl border border-black/5 space-y-8">
                  <div className="flex items-center justify-between">
                    <h3 className="text-xl font-bold flex items-center gap-2 uppercase tracking-tight font-sans"><Database className="text-black/30" /> Core Performance</h3>
                    <button onClick={() => setShowTrends(!showTrends)} className={`flex items-center gap-2 px-4 py-2 rounded-full text-[10px] font-bold uppercase tracking-widest transition-all ${showTrends ? 'bg-black text-[#FFCEFF]' : 'bg-black/5 text-black/40 hover:bg-black/10'}`}>
                        <History size={12} /> {showTrends ? 'Hide Trends' : 'Add Trends'}
                    </button>
                  </div>

                  <div className="grid grid-cols-2 gap-6">
                    <InputField label="Total Invited" name="totalInvites" value={formData.totalInvites} onChange={handleInputChange} placeholder="e.g. 5,000" />
                    <InputField label="Chat Completions" name="completions" value={formData.completions} onChange={handleInputChange} placeholder="e.g. 1,250" />
                  </div>
                  
                  {/* NEW FIELDS FOR COST OF VACANCY */}
                  <div className="grid grid-cols-2 gap-6">
                    <InputField 
                        label={`Actual Hires (${formData.dateRange})`} 
                        name="actualHires" 
                        value={formData.actualHires} 
                        onChange={handleInputChange} 
                        placeholder="e.g. 45" 
                        icon={<User size={12} className="text-black/20" />} 
                    />
                    {/* NEW RELATIVE HOURS FIELD */}
                    <InputField 
                        label="# Hiring Managers/Stores" 
                        name="numLocations" 
                        value={formData.numLocations} 
                        onChange={handleInputChange} 
                        placeholder="e.g. 50" 
                        icon={<Briefcase size={12} className="text-black/20" />} 
                    />
                  </div>

                  <div className="grid grid-cols-2 gap-6">
                    <InputField label="Leakage Rate (%)" name="leakageRate" value={formData.leakageRate} onChange={handleInputChange} placeholder="Did not start" />
                    <InputField label="Drop Out Rate (%)" name="dropOutRate" value={formData.dropOutRate} onChange={handleInputChange} placeholder="Started, no finish" />
                  </div>
                  <div className="grid grid-cols-2 gap-6">
                    <InputField label={`TA Hours Saved (${formData.dateRange})`} name="hoursSaved" value={formData.hoursSaved} onChange={handleInputChange} placeholder="Auto-calculated" icon={<Calculator size={12} className="text-black/20" />} />
                    <div className="space-y-6">
                        <InputField label="Sapia TTH (Days)" name="timeToHireSapia" value={formData.timeToHireSapia} onChange={handleInputChange} placeholder="e.g. 14" />
                        {showTrends && <InputField label="Previous TTH" name="prevTimeToHire" value={formData.prevTimeToHire} onChange={handleInputChange} placeholder="e.g. 18" isTrend />}
                    </div>
                  </div>
                  <div className="grid grid-cols-2 gap-6">
                    <InputField label="Sapia TTO (Days)" name="timeToOfferSapia" value={formData.timeToOfferSapia} onChange={handleInputChange} placeholder="Optional" />
                    {/* NEW VELOCITY FIELD */}
                    <div className="space-y-6">
                        <InputField label="% Hires < 7 Days" name="fastHiresPercent" value={formData.fastHiresPercent} onChange={handleInputChange} placeholder="e.g. 65" icon={<Timer size={12} className="text-black/20" />} />
                    </div>
                  </div>
                  <div className="grid grid-cols-2 gap-6">
                    <div className="space-y-6">
                        <InputField label="CSAT (/10)" name="csat" value={formData.csat} onChange={handleInputChange} placeholder="e.g. 9.2" />
                        {showTrends && <InputField label="Previous CSAT" name="prevCsat" value={formData.prevCsat} onChange={handleInputChange} placeholder="e.g. 8.5" isTrend />}
                    </div>
                    <div className="space-y-6">
                        <InputField label="Brand Advocacy (NPS): %" name="nps" value={formData.nps} onChange={handleInputChange} placeholder="e.g. 78" />
                        {showTrends && <InputField label="Previous NPS" name="prevNps" value={formData.prevNps} onChange={handleInputChange} placeholder="e.g. 70" isTrend />}
                    </div>
                  </div>
                  <div className="grid grid-cols-2 gap-6">
                    <InputField label="My Insights Value: %" name="insightsUseful" value={formData.insightsUseful} onChange={handleInputChange} placeholder="e.g. 85" />
                    {/* NEW ACCESSIBILITY FIELDS INTEGRATED HERE FOR BALANCE */}
                    <InputField label="% Completed on Mobile" name="percentMobile" value={formData.percentMobile} onChange={handleInputChange} placeholder="e.g. 72" icon={<Smartphone size={12} className="text-black/20" />} />
                  </div>
                  <div className="grid grid-cols-2 gap-6">
                    <InputField label="% Completed Outside 9-5" name="percentAfterHours" value={formData.percentAfterHours} onChange={handleInputChange} placeholder="e.g. 45" icon={<Moon size={12} className="text-black/20" />} />
                    <div className="invisible"></div>
                  </div>
                </div>
              </div>

              {/* RIGHT COLUMN: VERIFICATION & QUALITATIVE */}
              <div className="space-y-8">
                {/* NEW RETENTION & CHURN ECONOMICS SECTION */}
                <div className="bg-white p-10 rounded-[3rem] shadow-xl border border-black/5 space-y-8">
                  <h3 className="text-xl font-bold flex items-center gap-2 uppercase tracking-tight font-sans"><Banknote className="text-black/30" /> Retention Economics</h3>
                  <div className="grid grid-cols-2 gap-6">
                    <InputField label="Cost per Early Leaver" name="costPerLeaver" value={formData.costPerLeaver} onChange={handleInputChange} placeholder="e.g. 5000" />
                    <InputField label="Sapia 90-Day Retention (%)" name="sapiaRetention" value={formData.sapiaRetention} onChange={handleInputChange} placeholder="e.g. 92" />
                  </div>
                  <div className="p-4 bg-black/5 rounded-2xl text-[10px] text-black/50 font-sans leading-relaxed">
                    <strong>Pro Tip:</strong> Enter the retention rate of Sapia "YES" candidates. The AI will benchmark this against your industry average.
                  </div>
                </div>

                <div className="bg-white p-10 rounded-[3rem] shadow-xl border border-black/5 space-y-8">
                  <h3 className="text-xl font-bold flex items-center gap-2 uppercase tracking-tight font-sans"><ImageIcon className="text-black/30" /> Platform Verification</h3>
                  <div className="relative">
                    <input type="file" multiple accept="image/*" onChange={handleFileChange} className="hidden" id="evidence-upload" />
                    <label htmlFor="evidence-upload" className="w-full h-32 border-2 border-dashed border-black/10 rounded-2xl flex flex-col items-center justify-center cursor-pointer hover:bg-[#FFCEFF]/20 hover:border-[#FFCEFF] transition-all">
                      <p className="text-black/40 text-[10px] font-bold uppercase tracking-[0.2em] font-sans">Upload Discover Screenshots</p>
                    </label>
                  </div>
                  {files.length > 0 && (
                    <div className="grid grid-cols-3 gap-3">
                      {files.map(f => (
                        <div key={f.id} className="relative aspect-video rounded-lg overflow-hidden border border-black/5 shadow-sm">
                          <img src={f.preview} className="w-full h-full object-cover" />
                          <button onClick={() => removeFile(f.id)} className="absolute top-1 right-1 bg-black/60 p-1 rounded-full text-red-400"><X size={12} /></button>
                        </div>
                      ))}
                    </div>
                  )}
                </div>

                <div className="bg-white p-10 rounded-[3rem] shadow-xl border border-black/5 space-y-8">
                  <h3 className="text-xl font-bold flex items-center gap-2 uppercase tracking-tight font-sans"><Type className="text-black/30" /> Qualitative & DEI</h3>
                  
                  <div className="space-y-2">
                    <label className="text-[11px] font-bold uppercase tracking-widest opacity-40 font-sans">Raw DEI Stats (For Odds Calculation)</label>
                    <textarea 
                        name="deiRawData" 
                        value={formData.deiRawData} 
                        onChange={handleInputChange} 
                        className="w-full h-24 bg-black/5 border border-black/10 rounded-2xl p-4 text-black focus:outline-none focus:border-black transition-all font-medium font-sans text-xs" 
                        placeholder="e.g. Female: 200 apps, 20 hires. Male: 150 apps, 15 hires..." 
                    />
                  </div>
                  
                  <div className="space-y-2">
                    <label className="text-[11px] font-bold uppercase tracking-widest opacity-40 font-sans">Candidate Feedback</label>
                    <textarea name="verbatimFeedback" value={formData.verbatimFeedback} onChange={handleInputChange} className="w-full h-40 bg-black/5 border border-black/10 rounded-2xl p-6 text-black focus:outline-none focus:border-black transition-all font-medium font-sans" placeholder="Paste candidate feedback comments..." />
                  </div>
                  
                  <button onClick={generateStory} disabled={analyzing || !formData.customerName || !formData.completions} className="w-full bg-black text-white py-6 rounded-full font-bold text-xl flex items-center justify-center gap-3 hover:bg-black/90 transition-all disabled:opacity-50 font-sans shadow-lg">
                    {analyzing ? <><RefreshCw className="animate-spin" /> Analyzing Narrative...</> : <><Sparkles size={20} className="text-[#FFCEFF]" /> Turn Data into Impact</>}
                  </button>
                  {error && (
                    <div className="p-4 bg-red-500/10 border border-red-500/20 rounded-xl flex items-center gap-2 text-red-600 text-xs font-bold uppercase tracking-wider animate-pulse">
                       <AlertCircle size={14} /> {error}
                    </div>
                  )}
                </div>
              </div>
            </div>
          </div>
        )}

        {/* --- IMPACT DASHBOARD --- */}
        {reportData && view === 'dashboard' && (
          <div className="space-y-12 animate-in fade-in zoom-in-95 duration-1000">
            
            <div className="bg-white p-16 rounded-[4rem] border border-black/5 shadow-2xl relative overflow-hidden">
               <div className="absolute top-0 right-0 p-16 opacity-5 text-black no-print"><Sparkles size={300} /></div>
               <div className="flex flex-col md:flex-row items-center gap-16 relative z-10">
                  <div className="flex-1 space-y-8">
                    <div className="flex items-center gap-4 text-black/40 font-bold uppercase tracking-[0.4em] text-[10px] font-sans">
                        <span>Strategic Briefing ({formData.persona})</span>
                        {customerLogo && (
                            <>
                                <span className="h-px w-8 bg-black/20"></span>
                                <div className="flex items-center gap-2">
                                    <img src={customerLogo} alt="Customer" className="h-6 object-contain grayscale opacity-60" />
                                    <span>x</span>
                                    <span>Sapia.ai</span>
                                </div>
                            </>
                        )}
                        <span className="h-px w-8 bg-black/20"></span>
                        <span className="text-black/60">{formData.targetFocus} Focus</span>
                    </div>
                    <h2 className="text-5xl font-bold tracking-tighter mb-8 leading-[0.95] uppercase">{reportData.strategy.headline}</h2>
                    <p className="text-2xl text-black/70 font-medium leading-relaxed font-sans">{reportData.strategy.boardWin}</p>
                  </div>
                  
                  {/* ROI CARD - RECRUITER VALUE RECLAIMED */}
                  <div className="w-full md:w-[380px] bg-white p-12 rounded-[3.5rem] border-[4px] border-[#FFCEFF] flex flex-col justify-center text-center shadow-xl relative group">
                    <div className="text-[10px] font-bold uppercase tracking-[0.3em] mb-6 text-black/40 font-sans">Est. Annual Value Reclaimed</div>
                    
                    <div className="text-5xl lg:text-6xl font-black tracking-tighter mb-4 text-black leading-tight break-words transition-all">
                      ${reportData.roi.annualDollarsSaved.toLocaleString()}
                    </div>
                    
                    <div className="text-lg font-bold mb-8 text-black opacity-60 font-sans">({reportData.metrics.annualHoursSaved} Recruiter Hours)</div>
                    
                    {/* NEW RELATIVE HOURS DISPLAY IF APPLICABLE */}
                    {reportData.metrics.hoursPerLocation && (
                        <div className="bg-black/5 text-black py-2 px-4 rounded-full font-bold text-[9px] uppercase tracking-widest mb-2 font-sans">
                            {reportData.metrics.hoursPerLocation} Hours / Manager / {formData.dateRange}
                        </div>
                    )}

                    <div className="bg-black text-[#FFCEFF] py-3 rounded-full font-bold text-[10px] uppercase tracking-widest shadow-md font-sans">
                      +{reportData.roi.recruiterCapacityIncrease} Capacity Boost
                    </div>
                  </div>
               </div>
            </div>

            <div className="bg-white p-16 rounded-[4rem] border border-black/5 shadow-2xl relative overflow-hidden">
              <div className="flex flex-col space-y-12 relative z-10">
                <div className="flex items-center justify-between">
                   <div className="flex items-center gap-4">
                     <div className="p-3 bg-black rounded-2xl shadow-lg"><Filter className="text-[#FFCEFF]" /></div>
                     <h3 className="text-3xl font-bold tracking-tight uppercase tracking-tighter font-sans">Efficiency Journey Analysis</h3>
                   </div>
                   <div className="hidden md:flex items-center gap-2 text-black/30 font-bold uppercase tracking-[0.2em] text-[10px] font-sans">
                     <UserCheck size={14} /> Tracking {reportData.metrics.totalInvites.toLocaleString()} Candidates
                   </div>
                </div>

                <div className="grid grid-cols-1 lg:grid-cols-3 gap-16 items-center">
                   <div className="space-y-6">
                      <div className="text-[10px] font-bold uppercase tracking-[0.2em] text-black/30 font-sans">Sapia Domain Focus</div>
                      <p className="text-xl text-black/70 font-medium leading-relaxed font-sans">{reportData.funnel.controlInsight}</p>
                   </div>
                   
                   <div className="lg:col-span-2 flex flex-col md:flex-row gap-8">
                      <FunnelHorizontalBox 
                        label="Top of Funnel Leakage" 
                        percent={reportData.funnel.leakagePercent} 
                        sub="Outside Sapia Scope" 
                        note="Market Friction / Ghosting"
                      />
                      <FunnelHorizontalBox 
                        label="Platform Drop Out" 
                        percent={reportData.funnel.dropOutPercent} 
                        sub="Sapia Managed Pool" 
                        note="Engagement Efficiency"
                        highlight
                      />
                   </div>
                </div>
              </div>
            </div>

            <div className="bg-white p-16 rounded-[4rem] border border-black/5 shadow-2xl">
              <div className="flex items-center justify-between gap-4 mb-16">
                <div className="flex items-center gap-4">
                    <div className="p-4 bg-[#FFCEFF] rounded-2xl shadow-sm"><MapPin size={24} /></div>
                    <h3 className="text-3xl font-bold tracking-tight uppercase tracking-tighter font-sans">{formData.range} Benchmarking <span className="text-black/30 font-medium font-sans lowercase">vs industry standard</span></h3>
                </div>
                {/* DATA SOURCE CITATION */}
                {reportData.meta && reportData.meta.benchmarkSource && (
                    <div className="hidden md:flex items-center gap-2 px-4 py-2 bg-black/5 rounded-full">
                        <Info size={14} className="text-black/40" />
                        <span className="text-[10px] font-bold uppercase tracking-widest text-black/50 font-sans">
                            Data Source: {reportData.meta.benchmarkSource}
                        </span>
                    </div>
                )}
              </div>
              <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-10">
                <CompareColumn 
                    label="Time To Hire" 
                    sapia={`${reportData.metrics.tth.sapia} Days`} 
                    industry={`${reportData.metrics.tth.industry} Days`} 
                    trend={showTrends && formData.prevTimeToHire ? calculateTrend(reportData.metrics.tth.sapia, formData.prevTimeToHire, true) : null}
                    note={reportData.metrics.tth.sapia < reportData.metrics.tth.industry ? `-${Math.round((1 - reportData.metrics.tth.sapia / reportData.metrics.tth.industry) * 100)}% speed vs industry` : null} 
                />
                
                {/* NEW VELOCITY METRIC IF AVAILABLE */}
                {reportData.metrics.fastHiresPercent > 0 ? (
                    <CompareColumn 
                        label="Velocity (< 7 Days)" 
                        sapia={`${reportData.metrics.fastHiresPercent}%`} 
                        industry="< 15%" 
                        note="Speed to Quality"
                    />
                ) : (
                    <CompareColumn label="Time To Offer" sapia={`${reportData.metrics.tto.sapia || 'N/A'} Days`} industry={`${reportData.metrics.tto.industry} Days`} />
                )}

                <CompareColumn 
                    label="Experience (CSAT)" 
                    sapia={`${reportData.metrics.csat.sapia}/10`} 
                    industry={`${reportData.metrics.csat.industry}/10`} 
                    trend={showTrends && formData.prevCsat ? calculateTrend(reportData.metrics.csat.sapia, formData.prevCsat, false) : null}
                />
                <CompareColumn 
                    label="Brand Advocacy" 
                    sapia={`${reportData.metrics.nps.sapia}% NPS`} 
                    industry={`${reportData.metrics.nps.industry}% NPS`} 
                    trend={showTrends && formData.prevNps ? calculateTrend(reportData.metrics.nps.sapia, formData.prevNps, false) : null}
                />
              </div>
            </div>

            {/* NEW RETENTION & STABILITY CARD */}
            {reportData.roi.retentionDollarsSaved > 0 && (
                <div className="bg-black p-16 rounded-[4rem] shadow-2xl relative overflow-hidden text-white">
                    <div className="flex flex-col md:flex-row items-center gap-12 relative z-10">
                        <div className="flex-1 space-y-6">
                            <div className="flex items-center gap-4">
                                <div className="p-3 bg-[#FFCEFF]/10 rounded-2xl border border-[#FFCEFF]/20"><Banknote className="text-[#FFCEFF]" /></div>
                                <h3 className="text-3xl font-bold tracking-tight uppercase tracking-tighter font-sans text-[#FFCEFF]">Retention & Stability Impact</h3>
                            </div>
                            <p className="text-xl text-white/70 font-medium leading-relaxed font-sans max-w-2xl">
                                By optimizing for candidates who stay, we have avoided significant training and replacement costs.
                            </p>
                        </div>
                        <div className="w-full md:w-[400px] text-center">
                             <div className="text-[10px] font-bold uppercase tracking-[0.3em] mb-4 text-white/40 font-sans">Est. Annual Cost Avoidance</div>
                             <div className="text-5xl font-black tracking-tighter mb-2 text-white">
                                ${reportData.roi.retentionDollarsSaved.toLocaleString()}
                             </div>
                             <div className="text-xs font-bold uppercase tracking-widest text-green-400">
                                {reportData.roi.retentionDelta > 0 ? `+${reportData.roi.retentionDelta}% Retention vs Industry` : "Calculating Delta..."}
                             </div>
                        </div>
                    </div>
                </div>
            )}

            {/* NEW ENGAGEMENT & ACCESSIBILITY SECTION */}
            <div className="bg-white p-16 rounded-[4rem] border border-black/5 shadow-2xl">
              <div className="flex items-center gap-4 mb-16">
                <div className="p-4 bg-[#FFCEFF] rounded-2xl shadow-sm"><Award size={24} /></div>
                <h3 className="text-3xl font-bold tracking-tight uppercase tracking-tighter font-sans">Engagement & Accessibility</h3>
              </div>
              <div className="grid grid-cols-1 md:grid-cols-3 gap-10">
                <CompareColumn 
                    label="Feedback Coverage" 
                    sapia="100%" 
                    industry="< 15%" 
                    note="Ghosting Eliminated" 
                />
                <CompareColumn 
                    label="Completed on Mobile" 
                    sapia={reportData.metrics.percentMobile ? `${reportData.metrics.percentMobile}%` : '-'} 
                    industry="~45%" 
                    note="Low Barrier Entry"
                    icon={<Smartphone size={12} className="inline mr-1 opacity-40" />}
                />
                <CompareColumn 
                    label="Outside Business Hours" 
                    sapia={reportData.metrics.percentAfterHours ? `${reportData.metrics.percentAfterHours}%` : '-'} 
                    industry="0%" 
                    note="Passive Talent Capture"
                    icon={<Moon size={12} className="inline mr-1 opacity-40" />}
                />
              </div>
            </div>

            <div className="grid grid-cols-1 md:grid-cols-2 gap-10">
              <div className="bg-white p-16 rounded-[4rem] border-l-[16px] border-[#FFCEFF] shadow-2xl">
                <div className="flex items-center gap-4 mb-10 text-black/30">
                  <Heart size={20} />
                  <span className="font-bold uppercase tracking-widest text-[10px] font-sans">Human-Centric Insights</span>
                </div>
                <p className="text-3xl font-medium leading-tight mb-12 italic font-serif">"{reportData.candidateLove.topQuote}"</p>
                
                {/* NEW FAIRNESS ODDS DISPLAY IF AVAILABLE */}
                {reportData.candidateLove.fairnessOddsText && (
                    <div className="mb-8 p-6 bg-black/5 rounded-3xl border border-black/5">
                        <div className="flex items-center gap-2 mb-2 text-xs font-bold uppercase tracking-widest text-black/40"><Scale size={12} /> Fairness Protocol</div>
                        <p className="text-lg font-bold text-black">{reportData.candidateLove.fairnessOddsText}</p>
                    </div>
                )}

                <div className="flex flex-wrap gap-3">
                  {reportData.candidateLove.themes.map((t, i) => (
                    <span key={i} className="px-6 py-2 bg-black text-[#FFCEFF] rounded-full text-[10px] font-bold uppercase tracking-widest font-sans">{t}</span>
                  ))}
                </div>
              </div>

              <div className="bg-white p-16 rounded-[4rem] border border-black/5 shadow-2xl">
                <div className="flex items-center gap-4 mb-10 text-black/30">
                  <MessageSquareQuote size={20} />
                  <span className="font-bold uppercase tracking-widest text-[10px] font-sans">Executive Narrative</span>
                </div>
                <div className="space-y-6">
                  {reportData.strategy.talkingPoints.map((point, i) => (
                    <div key={i} className="flex gap-5 p-6 bg-black/5 rounded-3xl border border-black/5">
                      <div className="w-8 h-8 bg-black text-white rounded-xl flex items-center justify-center shrink-0 font-bold text-sm font-sans">{i+1}</div>
                      <p className="text-lg font-medium leading-snug font-sans">{point}</p>
                    </div>
                  ))}
                </div>
              </div>
            </div>

            {/* AI STRATEGIC ADVISOR SECTION */}
            <div className="grid grid-cols-1 md:grid-cols-2 gap-8 mt-12 no-print">
                <div className="bg-white p-10 rounded-[3rem] border border-black/5 shadow-xl">
                    <div className="flex items-center gap-3 mb-6">
                        <BrainCircuit size={24} className="text-[#FFCEFF]" />
                        <h3 className="text-xl font-bold font-sans">Strategic Roadmap</h3>
                    </div>
                    {aiInsights.roadmap ? (
                        <div className="space-y-4">
                            {aiInsights.roadmap.map((step, i) => (
                                <div key={i} className="p-4 bg-black/5 rounded-2xl">
                                    <div className="font-bold text-sm mb-1">{step.step}</div>
                                    <div className="text-xs text-black/60">{step.desc}</div>
                                </div>
                            ))}
                        </div>
                    ) : (
                        <div className="text-center py-8">
                            <p className="text-sm text-black/40 mb-6">Generate actionable steps to improve these metrics.</p>
                            <button 
                                onClick={() => generateAiInsight('roadmap')}
                                disabled={generatingInsight === 'roadmap'}
                                className="w-full py-4 bg-black text-white rounded-2xl font-bold text-xs uppercase tracking-widest flex items-center justify-center gap-2 hover:bg-black/90 transition-all"
                            >
                                {generatingInsight === 'roadmap' ? <RefreshCw className="animate-spin" size={14} /> : <Sparkles size={14} />} 
                                Generate Plan
                            </button>
                        </div>
                    )}
                </div>

                <div className="bg-white p-10 rounded-[3rem] border border-black/5 shadow-xl">
                    <div className="flex items-center gap-3 mb-6">
                        <HelpCircle size={24} className="text-[#FFCEFF]" />
                        <h3 className="text-xl font-bold font-sans">Q&A Prep</h3>
                    </div>
                    {aiInsights.qa ? (
                        <div className="space-y-4">
                            {aiInsights.qa.map((item, i) => (
                                <div key={i} className="p-4 bg-black/5 rounded-2xl">
                                    <div className="font-bold text-sm mb-2 text-red-500">Q: {item.question}</div>
                                    <div className="text-xs text-black/60 font-medium">A: {item.answer}</div>
                                </div>
                            ))}
                        </div>
                    ) : (
                        <div className="text-center py-8">
                            <p className="text-sm text-black/40 mb-6">Predict tough questions from a {formData.persona}.</p>
                            <button 
                                onClick={() => generateAiInsight('qa')}
                                disabled={generatingInsight === 'qa'}
                                className="w-full py-4 bg-black text-white rounded-2xl font-bold text-xs uppercase tracking-widest flex items-center justify-center gap-2 hover:bg-black/90 transition-all"
                            >
                                {generatingInsight === 'qa' ? <RefreshCw className="animate-spin" size={14} /> : <Sparkles size={14} />} 
                                Predict Questions
                            </button>
                        </div>
                    )}
                </div>
            </div>

          </div>
        )}

        {/* --- COMMS VIEW --- */}
        {reportData && view === 'comms' && (
          <div className="grid grid-cols-1 md:grid-cols-2 gap-10 animate-in slide-in-from-bottom-8 no-print">
            <CommsCard title="Leadership Social Hook" content={reportData.comms.linkedin} onCopy={copyToClipboard} icon={<LinkedinIcon size={20} />} />
            <CommsCard title="Success Briefing Memo" content={reportData.comms.internalEmail} onCopy={copyToClipboard} icon={<Mail size={20} />} />
          </div>
        )}
      </main>
    </div>
  );
};

// --- HELPER COMPONENTS ---

const calculateTrend = (current, previous, lowerIsBetter) => {
    const curr = parseFloat(current);
    const prev = parseFloat(previous);
    if (isNaN(curr) || isNaN(prev)) return null;
    
    const diff = curr - prev;
    const isGood = lowerIsBetter ? diff < 0 : diff > 0;
    
    return {
        val: Math.abs(diff).toFixed(1),
        isGood
    };
};

const InputField = ({ label, isTrend, icon, ...props }) => (
  <div className="space-y-2 relative">
    <label className={`text-[11px] font-bold uppercase tracking-widest font-sans ${isTrend ? 'text-black/30' : 'text-black/40 opacity-100'}`}>
        {isTrend && <History size={10} className="inline mr-1" />} {label}
    </label>
    <div className="relative">
        <input {...props} className={`w-full border rounded-2xl py-4 px-6 focus:outline-none focus:border-black transition-all placeholder:text-black/10 font-medium font-sans ${isTrend ? 'bg-[#FFCEFF]/10 border-[#FFCEFF] text-black/70' : 'bg-black/5 border-black/10'}`} />
        {icon && <div className="absolute right-4 top-1/2 -translate-y-1/2 pointer-events-none">{icon}</div>}
    </div>
  </div>
);

const NavBtn = ({ active, onClick, icon, label }) => (
  <button onClick={onClick} className={`flex items-center gap-2 px-6 py-2.5 rounded-full font-bold text-[11px] uppercase tracking-widest transition-all ${active ? 'bg-black text-white shadow-lg' : 'text-black/40 hover:text-black hover:bg-black/5'}`}>
    {icon} {label}
  </button>
);

const FunnelHorizontalBox = ({ label, percent, sub, note, highlight }) => (
  <div className={`flex-1 p-10 rounded-[3rem] border transition-all ${highlight ? 'bg-black text-[#FFCEFF] border-black shadow-xl' : 'bg-black/5 border-black/5 text-black shadow-sm'}`}>
    <div className="text-[10px] font-bold uppercase tracking-[0.2em] mb-4 opacity-50 font-sans">{label}</div>
    <div className="flex items-baseline gap-2 mb-2">
      <div className="text-5xl font-black tracking-tight">{percent}%</div>
      <div className="text-xs font-bold uppercase opacity-40 font-sans tracking-widest">{sub}</div>
    </div>
    <p className={`text-xs font-bold uppercase tracking-widest mt-4 ${highlight ? 'text-[#FFCEFF]/60' : 'text-black/30'} font-sans`}>
      {note}
    </p>
  </div>
);

const CompareColumn = ({ label, sapia, industry, note, trend, icon }) => (
  <div className="flex flex-col gap-6">
    <div className="text-black/30 font-bold uppercase tracking-widest text-[10px] font-sans flex justify-between">
        <span className="flex items-center gap-2">{icon} {label}</span>
        {trend && (
            <span className={`flex items-center gap-1 ${trend.isGood ? 'text-green-600' : 'text-red-500'}`}>
                {trend.isGood ? '' : ''} {trend.val}
            </span>
        )}
    </div>
    <div className="space-y-4">
      <div className="p-8 bg-[#FFCEFF] rounded-[2.5rem] border border-black/5 shadow-sm">
        <div className="text-[10px] font-bold uppercase tracking-widest mb-1 opacity-50 font-sans">Sapia Results</div>
        <div className="text-2xl font-black text-black">{sapia}</div>
      </div>
      <div className="p-8 bg-black/5 rounded-[2.5rem] border border-black/5 opacity-40">
        <div className="text-[10px] font-bold uppercase tracking-widest mb-1 opacity-50 font-sans text-black">Industry Benchmark</div>
        <div className="text-xl font-bold text-black">{industry}</div>
      </div>
      {note && <div className="text-[10px] font-bold uppercase text-black/40 px-2 font-medium tracking-tight uppercase tracking-tighter font-sans">{note}</div>}
    </div>
  </div>
);

const CommsCard = ({ title, content, onCopy, icon }) => (
  <div className="bg-white p-12 rounded-[3rem] border border-black/5 shadow-2xl flex flex-col h-full">
    <div className="flex items-center justify-between mb-10">
      <div className="flex items-center gap-4">
        <div className="p-3 bg-[#FFCEFF] rounded-xl shadow-sm">{icon}</div>
        <h3 className="text-2xl font-bold tracking-tight uppercase tracking-tighter">{title}</h3>
      </div>
      <button onClick={() => onCopy(content)} className="p-4 bg-black text-white hover:bg-black/80 transition-all rounded-2xl shadow-lg group">
        <Copy size={20} className="group-hover:scale-110 transition-transform" />
      </button>
    </div>
    <div className="flex-1 bg-black/5 p-10 rounded-[2rem] border border-black/5 text-lg font-medium leading-relaxed whitespace-pre-wrap overflow-y-auto max-h-[450px] font-sans text-black/70">
      {content}
    </div>
  </div>
);

export default App;
